@model Models.OrdemServico

@{
    ViewData["Title"] = "Create";
}

<h1>Criar Ordem de Serviço</h1>

<h4>Dados da OS</h4>
<hr />
<div class="row">
    <div class="col-md-12">
        <form asp-action="Create" id="osForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="ClienteId" class="form-label">Cliente</label>
                    <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.ClienteId"></select>
                </div>
                <div class="col-md-4">
                    <label asp-for="VeiculoId" class="form-label">Veículo</label>
                    <select asp-for="VeiculoId" class="form-select" asp-items="ViewBag.VeiculoId"></select>
                </div>
                <div class="col-md-4">
                    <label asp-for="MecanicoId" class="form-label">Mecânico</label>
                    <select asp-for="MecanicoId" class="form-select" asp-items="ViewBag.MecanicoId"></select>
                </div>
                <div class="col-md-8">
                    <label asp-for="Descricao" class="form-label">Descrição</label>
                    <input asp-for="Descricao" class="form-control" />
                    <span asp-validation-for="Descricao" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="DataPrevista" class="form-label">Data Prevista</label>
                    <input asp-for="DataPrevista" type="date" class="form-control" />
                    <span asp-validation-for="DataPrevista" class="text-danger"></span>
                </div>
                <div class="col-12">
                    <label asp-for="Observacoes" class="form-label">Observações</label>
                    <input asp-for="Observacoes" class="form-control" />
                    <span asp-validation-for="Observacoes" class="text-danger"></span>
                </div>
            </div>

            <hr />
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Serviços</h5>
                        <button type="button" id="addServico" class="btn btn-sm btn-primary">Adicionar Serviço</button>
                    </div>
                    <table class="table table-sm" id="tblServicos">
                        <thead>
                            <tr><th>Descrição</th><th class="text-end">Valor (R$)</th><th></th></tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr><th>Total</th><th class="text-end" id="totServ">R$ 0,00</th><th></th></tr>
                        </tfoot>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Peças</h5>
                        <button type="button" id="addPeca" class="btn btn-sm btn-primary">Adicionar Peça</button>
                    </div>
                    <table class="table table-sm" id="tblPecas">
                        <thead>
                            <tr><th>Nome</th><th class="text-end">Vlr. Unit. (R$)</th><th class="text-end">Qtd</th><th class="text-end">Total</th><th></th></tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr><th colspan="3">Total</th><th class="text-end" id="totPecas">R$ 0,00</th><th></th></tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-success">Salvar OS</button>
                <a asp-action="Index" class="btn btn-secondary ms-2">Voltar</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        (function(){
            let sIdx = 0, pIdx = 0;
            const fmt = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
            const recalc = () => {
                let tS=0, tP=0;
                document.querySelectorAll('#tblServicos tbody tr').forEach(tr=>{ tS += parseFloat(tr.querySelector('input[name$=\.Valor]')?.value||0); });
                document.querySelectorAll('#tblPecas tbody tr').forEach(tr=>{ const u=parseFloat(tr.querySelector('input[name$=\.ValorUnitario]')?.value||0); const q=parseInt(tr.querySelector('input[name$=\.Quantidade]')?.value||0); const tot=u*q; tr.querySelector('.cellTot')!.textContent = fmt(tot); tP += tot; });
                document.getElementById('totServ').textContent = fmt(tS);
                document.getElementById('totPecas').textContent = fmt(tP);
            };
            document.getElementById('addServico').addEventListener('click', ()=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input name="servicos[${sIdx}].Descricao" class="form-control form-control-sm"/></td>
                                <td class="text-end"><input type="number" step="0.01" name="servicos[${sIdx}].Valor" class="form-control form-control-sm text-end"/></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger del">X</button></td>`;
                sIdx++;
                tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',recalc));
                tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); recalc(); });
                document.querySelector('#tblServicos tbody').appendChild(tr);
            });
            document.getElementById('addPeca').addEventListener('click', ()=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input name="pecas[${pIdx}].Nome" class="form-control form-control-sm"/></td>
                                <td class="text-end"><input type="number" step="0.01" name="pecas[${pIdx}].ValorUnitario" class="form-control form-control-sm text-end"/></td>
                                <td class="text-end"><input type="number" step="1" name="pecas[${pIdx}].Quantidade" class="form-control form-control-sm text-end" value="1"/></td>
                                <td class="text-end cellTot">R$ 0,00</td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger del">X</button></td>`;
                pIdx++;
                tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',recalc));
                tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); recalc(); });
                document.querySelector('#tblPecas tbody').appendChild(tr);
            });
        })();
    </script>
}
