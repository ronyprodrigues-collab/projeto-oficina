@model Models.OrdemServico

@{
    ViewData["Title"] = "Editar Ordem de Serviço";
    var pecasCatalogo = ViewBag.PecasEstoque as IEnumerable<Models.PecaEstoque> ?? System.Linq.Enumerable.Empty<Models.PecaEstoque>();
    var cultura = System.Globalization.CultureInfo.GetCultureInfo("pt-BR");
}

<h1>Editar Ordem de Serviço</h1>

<h4>Dados da OS</h4>
<hr />
<div class="row">
    <div class="col-md-12">
        <form asp-action="Edit" id="osForm">
            <input type="hidden" asp-for="Id" />
            <div asp-validation-summary="All" class="text-danger mb-2"></div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="ClienteId" class="form-label">Cliente</label>
                    <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.ClienteId" required></select>
                </div>
                <div class="col-md-4">
                    <label asp-for="VeiculoId" class="form-label">Veículo</label>
                    <select asp-for="VeiculoId" class="form-select" asp-items="ViewBag.VeiculoId" required></select>
                </div>
                <div class="col-md-4">
                    <label asp-for="MecanicoId" class="form-label">Mecânico</label>
                    <select asp-for="MecanicoId" class="form-select" asp-items="ViewBag.MecanicoId" required></select>
                </div>
                <div class="col-md-8">
                    <label asp-for="Descricao" class="form-label">Descrição</label>
                    <input asp-for="Descricao" class="form-control" required />
                    <span asp-validation-for="Descricao" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="DataPrevista" class="form-label">Data Prevista</label>
                    <input asp-for="DataPrevista" type="date" class="form-control" />
                </div>
                <div class="col-12">
                    <label asp-for="Observacoes" class="form-label">Observações</label>
                    <input asp-for="Observacoes" class="form-control" />
                </div>
            </div>

            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Serviços</h5>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#mdlServico">Adicionar Serviço</button>
                    </div>
                    <table class="table table-sm" id="tblServicos">
                        <thead><tr><th>Descrição</th><th class="text-end">Valor (R$)</th><th></th></tr></thead>
                        <tbody>
                        @if (Model?.Servicos != null)
                        {
                            var i = 0;
                            foreach (var s in Model.Servicos)
                            {
                                <tr>
                                    <td><input name="servicos[@i].Descricao" class="form-control form-control-sm" value="@s.Descricao" /></td>
                                    <td class="text-end"><input type="text" inputmode="decimal" name="servicos[@i].Valor" class="form-control form-control-sm text-end" value="@s.Valor.ToString("F2", cultura)" /></td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger del">X</button></td>
                                </tr>
                                i++;
                            }
                        }
                        </tbody>
                        <tfoot><tr><th>Total</th><th class="text-end" id="totServ">R$ 0,00</th><th></th></tr></tfoot>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Peças</h5>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#mdlPeca">Adicionar Peça</button>
                    </div>
                    <table class="table table-sm" id="tblPecas">
                        <thead><tr><th>Nome</th><th class="text-end">Vlr. Unit. (R$)</th><th class="text-end">Qtd</th><th class="text-end">Total</th><th></th></tr></thead>
                        <tbody>
                        @if (Model?.Pecas != null)
                        {
                            var j = 0;
                            foreach (var p in Model.Pecas)
                            {
                                var tot = p.ValorUnitario * p.Quantidade;
                                <tr>
                                    <td><input name="pecas[@j].Nome" class="form-control form-control-sm" value="@p.Nome" /><input type="hidden" name="pecas[@j].PecaEstoqueId" value="" /></td>
                                    <td class="text-end"><input type="text" inputmode="decimal" name="pecas[@j].ValorUnitario" class="form-control form-control-sm text-end" value="@p.ValorUnitario.ToString("F2", cultura)" /></td>
                                    <td class="text-end"><input type="number" step="1" name="pecas[@j].Quantidade" class="form-control form-control-sm text-end" value="@p.Quantidade" /></td>
                                    <td class="text-end cellTot">@tot.ToString("C", cultura)</td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger del">X</button></td>
                                </tr>
                                j++;
                            }
                        }
                        </tbody>
                        <tfoot><tr><th colspan="3">Total</th><th class="text-end" id="totPecas">R$ 0,00</th><th></th></tr></tfoot>
                    </table>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-12 text-end">
                    <h5 class="m-0">Total Geral: <span id="totGeral">R$ 0,00</span></h5>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-success">Salvar</button>
                <a asp-action="Index" class="btn btn-secondary ms-2">Voltar</a>
            </div>
        </form>
    </div>
</div>

<!-- Modal Serviço -->
<div class="modal fade" id="mdlServico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Adicionar Serviço</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-3"><label class="form-label">Descrição</label><input id="svDesc" type="text" class="form-control"><div class="invalid-feedback">Informe a descrição.</div></div>
            <div class="mb-3"><label class="form-label">Valor (R$)</label><input id="svValor" type="text" inputmode="decimal" class="form-control"><div class="invalid-feedback">Informe um valor válido.</div></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" id="btnAddServico" class="btn btn-primary">Adicionar</button></div>
    </div></div>
</div>

<!-- Modal Peça -->
<div class="modal fade" id="mdlPeca" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Adicionar Peça</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Peça do estoque</label>
                <select id="pcPecaId" class="form-select">
                    <option value="">Selecione...</option>
                    @foreach (var item in pecasCatalogo)
                    {
                        var preco = item.PrecoVenda ?? 0m;
                        <option value="@item.Id" data-nome="@item.Nome" data-preco="@preco.ToString(System.Globalization.CultureInfo.InvariantCulture)">
                            @item.Nome (@item.UnidadeMedida) - @preco.ToString("C", cultura)
                        </option>
                    }
                </select>
                <div class="form-text">Selecione uma peça do estoque para preencher nome e valor automaticamente.</div>
            </div>
            <div class="mb-3"><label class="form-label">Nome</label><input id="pcNome" type="text" class="form-control"><div class="invalid-feedback">Informe o nome da peça.</div></div>
            <div class="mb-3"><label class="form-label">Valor Unitário (R$)</label><input id="pcVlr" type="text" inputmode="decimal" class="form-control"><div class="invalid-feedback">Informe um valor válido.</div></div>
            <div class="mb-3"><label class="form-label">Quantidade</label><input id="pcQtd" type="number" step="1" min="1" value="1" class="form-control"><div class="invalid-feedback">Informe uma quantidade válida.</div></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" id="btnAddPeca" class="btn btn-primary">Adicionar</button></div>
    </div></div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        (function(){
            let sIdx=document.querySelectorAll('#tblServicos tbody tr').length;
            let pIdx=document.querySelectorAll('#tblPecas tbody tr').length;
            const fmt = v=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
            const toNum = v=>{ if(v===undefined||v===null) return 0; const n=parseFloat((''+v).replace(',','.')); return isNaN(n)?0:n; };
            const recalc = ()=>{
                let tS=0, tP=0;
                document.querySelectorAll('#tblServicos tbody input').forEach(inp=>{ if(inp.name && inp.name.endsWith('.Valor')) tS += toNum(inp.value); });
                document.querySelectorAll('#tblPecas tbody tr').forEach(tr=>{
                    let u=0,q=0; tr.querySelectorAll('input').forEach(inp=>{ if(inp.name&&inp.name.endsWith('.ValorUnitario')) u=toNum(inp.value); if(inp.name&&inp.name.endsWith('.Quantidade')) q=toNum(inp.value); });
                    const tot=u*q; const cell=tr.querySelector('.cellTot'); if(cell) cell.textContent=fmt(tot); tP+=tot; });
                const elS=document.getElementById('totServ'); if(elS) elS.textContent=fmt(tS);
                const elP=document.getElementById('totPecas'); if(elP) elP.textContent=fmt(tP);
                const elG=document.getElementById('totGeral'); if(elG) elG.textContent=fmt(tS+tP);
            };
            function wireRow(tr){
                tr.querySelectorAll('input').forEach(i=>{
                    i.addEventListener('input',recalc);
                    i.addEventListener('blur',()=>{
                        if(i.name.endsWith('.Valor') || i.name.endsWith('.ValorUnitario')){
                            i.value = toNum(i.value).toFixed(2).replace('.', ',');
                        }
                        recalc();
                    });
                });
                tr.querySelector('.del')?.addEventListener('click',()=>{ tr.remove(); recalc();});
            }
            document.querySelectorAll('#tblServicos tbody tr').forEach(wireRow);
            document.querySelectorAll('#tblPecas tbody tr').forEach(wireRow);

            function addServicoRow(desc, valor){
                const tb=document.querySelector('#tblServicos tbody');
                const v = (valor? toNum(valor).toFixed(2):'').replace('.', ',');
                const tr=document.createElement('tr');
                tr.innerHTML=`<td><input name="servicos[${sIdx}].Descricao" class="form-control form-control-sm" value="${desc||''}"/></td><td class="text-end"><input type="text" inputmode="decimal" name="servicos[${sIdx}].Valor" class="form-control form-control-sm text-end" value="${v}"/></td><td><button type="button" class="btn btn-sm btn-outline-danger del">X</button></td>`;
                sIdx++;
                wireRow(tr);
                tb.appendChild(tr);
                recalc();
            }
            function addPecaRow(nome, unit, qtd, estoqueId){
                const tb=document.querySelector('#tblPecas tbody');
                const u = (unit? toNum(unit).toFixed(2):'').replace('.', ',');
                const tr=document.createElement('tr');
                tr.innerHTML=`<td><input name="pecas[${pIdx}].Nome" class="form-control form-control-sm" value="${nome||''}"/><input type="hidden" name="pecas[${pIdx}].PecaEstoqueId" value="${estoqueId||''}"/></td><td class="text-end"><input type="text" inputmode="decimal" name="pecas[${pIdx}].ValorUnitario" class="form-control form-control-sm text-end" value="${u}"/></td><td class="text-end"><input type="number" step="1" name="pecas[${pIdx}].Quantidade" class="form-control form-control-sm text-end" value="${qtd||1}"/></td><td class="text-end cellTot">R$ 0,00</td><td><button type="button" class="btn btn-sm btn-outline-danger del">X</button></td>`;
                pIdx++;
                wireRow(tr);
                tb.appendChild(tr);
                recalc();
            }
            function getVal(id){ var el=document.getElementById(id); return el&&el.value!==undefined?el.value:''; }
            function hideModal(id){ var el=document.getElementById(id); if(el && typeof bootstrap!=='undefined'){ var m=bootstrap.Modal.getInstance(el); if(m) m.hide(); }}
            const ddlPeca=document.getElementById('pcPecaId');
            const nomePeca=document.getElementById('pcNome');
            const valorPeca=document.getElementById('pcVlr');
            const qtdPeca=document.getElementById('pcQtd');
            function limparPecaModal(){
                if(ddlPeca){ ddlPeca.value=''; }
                if(nomePeca){ nomePeca.value=''; nomePeca.classList.remove('is-invalid'); nomePeca.removeAttribute('readonly'); }
                if(valorPeca){ valorPeca.value=''; valorPeca.classList.remove('is-invalid'); valorPeca.removeAttribute('readonly'); }
                if(qtdPeca){ qtdPeca.value='1'; qtdPeca.classList.remove('is-invalid'); }
            }
            function aplicarPrecoCatalogo(){
                if(!ddlPeca) return;
                var opt = ddlPeca.selectedOptions && ddlPeca.selectedOptions.length>0 ? ddlPeca.selectedOptions[0] : null;
                if(!opt || !opt.value){
                    if(nomePeca) nomePeca.removeAttribute('readonly');
                    if(valorPeca) valorPeca.removeAttribute('readonly');
                    return;
                }
                var preco = toNum(opt.dataset.preco);
                if(nomePeca){ nomePeca.value = opt.dataset.nome || ''; nomePeca.setAttribute('readonly','readonly'); }
                if(valorPeca){ valorPeca.value = preco.toFixed(2).replace('.', ','); valorPeca.setAttribute('readonly','readonly'); }
            }
            if(ddlPeca){ ddlPeca.addEventListener('change', aplicarPrecoCatalogo); }
            var m1=document.getElementById('mdlServico'); if(m1) m1.addEventListener('show.bs.modal',()=>{ document.getElementById('svDesc').value=''; document.getElementById('svValor').value=''; });
            var m2=document.getElementById('mdlPeca'); if(m2) m2.addEventListener('show.bs.modal',()=>{ limparPecaModal(); });
            document.getElementById('btnAddServico')?.addEventListener('click',()=>{ var d=getVal('svDesc'); var v=getVal('svValor'); if(!d||toNum(v)<=0){ if(!d) document.getElementById('svDesc').classList.add('is-invalid'); if(toNum(v)<=0) document.getElementById('svValor').classList.add('is-invalid'); return;} addServicoRow(d,v); hideModal('mdlServico'); });
            document.getElementById('btnAddPeca')?.addEventListener('click',()=>{ var estoqueId=getVal('pcPecaId'); var n=getVal('pcNome'); var u=getVal('pcVlr'); var q=getVal('pcQtd')||'1'; var nomeValido = !(!estoqueId && !n); var valorValido = toNum(u) > 0; var qtdValida = toNum(q) > 0; if(!nomeValido || !valorValido || !qtdValida){ if(!nomeValido && nomePeca) nomePeca.classList.add('is-invalid'); if(!valorValido && valorPeca) valorPeca.classList.add('is-invalid'); if(!qtdValida && qtdPeca) qtdPeca.classList.add('is-invalid'); return;} addPecaRow(n,u,q,estoqueId); hideModal('mdlPeca'); limparPecaModal(); });
            document.getElementById('osForm')?.addEventListener('submit',function(e){ var hasServ=document.querySelectorAll('#tblServicos tbody tr').length>0; var hasPec=document.querySelectorAll('#tblPecas tbody tr').length>0; if(!hasServ && !hasPec){ e.preventDefault(); alert('Inclua pelo menos um Serviço ou uma Peça antes de salvar.'); }});

            document.addEventListener('blur', function(ev){
                var t = ev.target;
                if (!t || !t.name) return;
                if (t.name.endsWith('.Valor') || t.name.endsWith('.ValorUnitario')) {
                    t.value = toNum(t.value).toFixed(2).replace('.', ',');
                    recalc();
                }
            }, true);
            recalc();
        })();
    </script>
}
