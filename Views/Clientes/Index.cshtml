@model IEnumerable<Models.Cliente>

@{
    ViewData["Title"] = "Clientes";
}

<div class="d-flex align-items-center mb-3">
    <h1 class="m-0 flex-grow-1 text-center">Clientes</h1>
    <div class="d-flex gap-2">
        <a asp-action="Import" class="btn btn-outline-secondary">Importar planilha</a>
        <a asp-action="Vincular" class="btn btn-outline-primary">Vincular existente</a>
        <a asp-action="Create" class="btn btn-primary">Novo Cliente</a>
    </div>
</div>
<table class="table table-striped table-hover datatable">
    <thead>
        <tr>
            <th class="dt-filter">Nome</th>
            <th class="dt-filter">CPF/CNPJ</th>
            <th>Telefone</th>
            <th>E-mail</th>
            <th>Endereço</th>
            <th>Origem</th>
            <th style="width:160px;">Ações</th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Nome)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.CPF_CNPJ)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Telefone)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Email)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Endereco)
            </td>
            <td>
                @string.Join(", ", item.Oficinas.Select(o => o.Oficina?.Nome ?? "Desconhecida"))
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <a class="btn btn-outline-primary" asp-action="Edit" asp-route-id="@item.Id">Editar</a>
                    <a class="btn btn-outline-secondary" asp-action="Details" asp-route-id="@item.Id">Detalhes</a>
                    <a class="btn btn-outline-danger" asp-action="Delete" asp-route-id="@item.Id">Excluir</a>
                </div>
            </td>
        </tr>
}
    </tbody>
</table>

@section Scripts {
    <script>
        $(function(){
            var $t = $('table.datatable');
            if (!$t.length) return;
            if ($.fn.DataTable.isDataTable($t)) { $t.DataTable().destroy(); }
            $t.find('thead tr.dt-filters').remove();

            var $thead = $t.find('thead');
            var $header = $thead.find('tr').first();
            var cols = $header.find('th').length;
            var $f = $('<tr class="dt-filters"/>');
            for (let i=0;i<cols;i++){
                var $th = $('<th/>');
                if (i === 0) {
                    $th.append('<input type="text" class="form-control form-control-sm" placeholder="Filtrar" />');
                } else if (i === 1) {
                    $th.append('<select class="form-select form-select-sm"><option value="">Todos</option></select>');
                }
                $f.append($th);
            }
            $header.after($f);

            var dt = $t.DataTable({
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'pageLength', className: 'btn btn-sm btn-primary' },
                    { extend: 'copy', className: 'btn btn-sm btn-primary' },
                    { extend: 'csv', className: 'btn btn-sm btn-primary' },
                    { extend: 'excel', className: 'btn btn-sm btn-primary' },
                    { extend: 'pdf', className: 'btn btn-sm btn-primary' },
                    { extend: 'print', className: 'btn btn-sm btn-primary' },
                    { extend: 'colvis', className: 'btn btn-sm btn-primary' }
                ],
                paging: true,
                lengthChange: true,
                stateSave: true,
                orderCellsTop: true,
                autoWidth: false,
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-BR.json' }
            });

            var $nome = $f.find('th').eq(0).find('input');
            var $cpf = $f.find('th').eq(1).find('select');
            dt.column(1).data().unique().sort().each(function(d){
                var text = $('<div>').html(d).text().trim();
                if (text && $cpf.find('option').filter(function(){return $(this).text()===text;}).length===0){
                    $cpf.append(new Option(text,text));
                }
            });
            var to=null; $nome.on('keyup change', function(){ clearTimeout(to); var v=this.value; to=setTimeout(function(){ dt.column(0).search(v).draw(); }, 200); });
            $cpf.on('change', function(){ var v=$.fn.dataTable.util.escapeRegex($(this).val()); dt.column(1).search(v? '^'+v+'$' : '', true, false).draw(); });
            $t.attr('data-dt-initialized','1');
        });
    </script>
}
