@model IEnumerable<Models.Veiculo>

@{
    ViewData["Title"] = "Veículos";
}

<div class="d-flex align-items-center mb-3">
    <h1 class="m-0 flex-grow-1 text-center">Veículos</h1>
    <div class="d-flex gap-2">
        <a asp-action="Vincular" class="btn btn-outline-primary">Vincular existente</a>
        <a asp-action="Create" class="btn btn-primary">Novo Veículo</a>
    </div>
</div>
@if (TempData["Success"] != null)
{
    <div class="alert alert-success" role="alert">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger" role="alert">@TempData["Error"]</div>
}
<table class="table table-striped table-hover datatable">
    <thead>
        <tr>
            <th class="dt-filter">Placa</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Ano</th>
            <th class="dt-filter">Cliente</th>
            <th>Origem</th>
            <th style="width:160px;">Ações</th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Placa)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Marca)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Modelo)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Ano)
            </td>
            <td>
                @(item.Cliente != null ? item.Cliente.Nome : "-")
            </td>
            <td>
                @string.Join(", ", item.Oficinas.Select(o => o.Oficina?.Nome ?? "Desconhecida"))
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <a class="btn btn-outline-primary" asp-action="Edit" asp-route-id="@item.Id">Editar</a>
                    <a class="btn btn-outline-secondary" asp-action="Details" asp-route-id="@item.Id">Detalhes</a>
                    <a class="btn btn-outline-danger" asp-action="Delete" asp-route-id="@item.Id">Excluir</a>
                </div>
            </td>
        </tr>
}
    </tbody>
</table>

@section Scripts {
    <script>
        $(function(){
            var $t = $('table.datatable');
            if (!$t.length) return;
            if ($.fn.DataTable.isDataTable($t)) { $t.DataTable().destroy(); }
            $t.find('thead tr.dt-filters').remove();

            var $thead = $t.find('thead');
            var $header = $thead.find('tr').first();
            var cols = $header.find('th').length;
            var $f = $('<tr class="dt-filters"/>');
            for (let i=0;i<cols;i++){
                var $th = $('<th/>');
                if (i === 0) { // Placa texto
                    $th.append('<input type="text" class="form-control form-control-sm" placeholder="Filtrar" />');
                } else if (i === 4) { // Cliente select
                    $th.append('<select class="form-select form-select-sm"><option value="">Todos</option></select>');
                }
                $f.append($th);
            }
            $header.after($f);

            var clearState = @(TempData["ClearTableState"] != null ? "true" : "false");
            if (clearState === true || clearState === 'true') {
                try {
                    Object.keys(localStorage).filter(k => k.startsWith('DataTables_')).forEach(k => localStorage.removeItem(k));
                } catch {}
            }
            var dt = $t.DataTable({
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'pageLength', className: 'btn btn-sm btn-primary' },
                    { extend: 'copy', className: 'btn btn-sm btn-primary' },
                    { extend: 'csv', className: 'btn btn-sm btn-primary' },
                    { extend: 'excel', className: 'btn btn-sm btn-primary' },
                    { extend: 'pdf', className: 'btn btn-sm btn-primary' },
                    { extend: 'print', className: 'btn btn-sm btn-primary' },
                    { extend: 'colvis', className: 'btn btn-sm btn-primary' }
                ],
                paging: true,
                lengthChange: true,
                stateSave: true,
                stateLoadParams: function (settings, data) {
                    if (clearState === true || clearState === 'true') {
                        data.search.search = '';
                        if (data.columns) { data.columns.forEach(c => { if (c.search) c.search.search = ''; }); }
                    }
                },
                orderCellsTop: true,
                autoWidth: false,
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-BR.json' }
            });

            var $placa = $f.find('th').eq(0).find('input');
            var $cliente = $f.find('th').eq(4).find('select');
            dt.column(4).data().unique().sort().each(function(d){
                var text = $('<div>').html(d).text().trim();
                if (text && $cliente.find('option').filter(function(){return $(this).text()===text;}).length===0){
                    $cliente.append(new Option(text,text));
                }
            });
            // Restore saved state to UI controls
            var savedPlaca = dt.column(0).search();
            if (savedPlaca) { $placa.val(savedPlaca); }
            var savedCli = dt.column(4).search();
            if (savedCli && savedCli.startsWith('^') && savedCli.endsWith('$')) { savedCli = savedCli.substring(1, savedCli.length-1); }
            if (savedCli) { $cliente.val(savedCli); }

            var to=null; $placa.on('keyup change', function(){ clearTimeout(to); var v=this.value; to=setTimeout(function(){ dt.column(0).search(v).draw(); }, 200); });
            $cliente.on('change', function(){ var v=$.fn.dataTable.util.escapeRegex($(this).val()); dt.column(4).search(v? '^'+v+'$' : '', true, false).draw(); });
            $t.attr('data-dt-initialized','1');
        });
    </script>
}
