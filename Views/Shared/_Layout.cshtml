@using Microsoft.AspNetCore.Identity
@using Models
@inject UserManager<Models.ApplicationUser> UserManager
@inject SignInManager<Models.ApplicationUser> SignInManager
@inject Services.IConfiguracoesService ConfigService
@inject Services.IOficinaContext OficinaContext

@{
    const string defaultBrandName = "Controle de Oficina";
    var appName = defaultBrandName;
    var userPrincipal = User ?? new System.Security.Claims.ClaimsPrincipal();
    bool signedIn = SignInManager.IsSignedIn(userPrincipal);
    var currentUser = signedIn ? await UserManager.GetUserAsync(userPrincipal) : null;
    var displayName = currentUser?.NomeCompleto ?? userPrincipal.Identity?.Name ?? "Convidado";
    bool isAuthenticated = signedIn;
    bool isAdmin = userPrincipal.IsInRole("Admin");
    bool isAdminOrSupervisor = isAdmin || userPrincipal.IsInRole("Supervisor");
    bool isMecanico = userPrincipal.IsInRole("Mecanico");
    bool isSuporte = userPrincipal.IsInRole("SuporteTecnico");
    bool isDiretor = userPrincipal.IsInRole("Diretor");
    var controllerName = ViewContext.RouteData.Values["controller"]?.ToString() ?? string.Empty;
    bool isEstoqueSection = new[] { "Estoque", "MovimentacaoEstoque", "Peca" }
        .Contains(controllerName ?? string.Empty, StringComparer.OrdinalIgnoreCase);
    bool isPainelPage = string.Equals(controllerName, "Painel", System.StringComparison.OrdinalIgnoreCase);
    var cfg = await ConfigService.GetAsync();
    var configuredAppName = !string.IsNullOrWhiteSpace(cfg?.NomeOficina) ? cfg!.NomeOficina! : defaultBrandName;
    string PlanoLabel(PlanoConta plano) => plano switch
    {
        PlanoConta.Basico => "Básico",
        PlanoConta.Pro => "Pro",
        PlanoConta.Plus => "Plus",
        _ => plano.ToString()
    };
    Models.Oficina? oficinaAtual = null;
    if (isAuthenticated)
    {
        oficinaAtual = await OficinaContext.GetOficinaAtualAsync();
    }
    var planoAtual = oficinaAtual?.Plano ?? cfg?.PlanoAtual ?? PlanoConta.Basico;
    bool planoTemEstoque = planoAtual >= PlanoConta.Pro;
    bool planoTemFinanceiro = planoAtual >= PlanoConta.Plus;
    var nomeOficinaSelecionada = oficinaAtual?.Nome;
    var grupoAtual = oficinaAtual?.Grupo?.Nome;
    bool possuiOficinaSelecionada = oficinaAtual != null;
    var nomeOficinaAtual = nomeOficinaSelecionada ?? "Nenhuma oficina selecionada";
    appName = possuiOficinaSelecionada
        ? (nomeOficinaSelecionada ?? configuredAppName)
        : defaultBrandName;
    var brandLabel = defaultBrandName;
    if (possuiOficinaSelecionada)
    {
        if (!string.IsNullOrWhiteSpace(grupoAtual) && !string.IsNullOrWhiteSpace(nomeOficinaSelecionada))
        {
            brandLabel = $"{grupoAtual} · {nomeOficinaSelecionada}";
        }
        else if (!string.IsNullOrWhiteSpace(grupoAtual))
        {
            brandLabel = grupoAtual!;
        }
        else if (!string.IsNullOrWhiteSpace(nomeOficinaSelecionada))
        {
            brandLabel = nomeOficinaSelecionada!;
        }
        else
        {
            brandLabel = configuredAppName;
        }
    }
    string corPrimariaAtual = !string.IsNullOrWhiteSpace(oficinaAtual?.Grupo?.CorPrimaria)
        ? oficinaAtual!.Grupo!.CorPrimaria
        : (!string.IsNullOrWhiteSpace(cfg?.CorPrimaria) ? cfg!.CorPrimaria! : "#0d6efd");
    string corSecundariaAtual = !string.IsNullOrWhiteSpace(oficinaAtual?.Grupo?.CorSecundaria)
        ? oficinaAtual!.Grupo!.CorSecundaria
        : (!string.IsNullOrWhiteSpace(cfg?.CorSecundaria) ? cfg!.CorSecundaria! : "#6c757d");
    var viewOverridePrimary = ViewContext?.ViewData?["ThemePrimaryOverride"] as string;
    var viewOverrideSecondary = ViewContext?.ViewData?["ThemeSecondaryOverride"] as string;
    if (!string.IsNullOrWhiteSpace(viewOverridePrimary))
    {
        corPrimariaAtual = viewOverridePrimary!;
    }
    if (!string.IsNullOrWhiteSpace(viewOverrideSecondary))
    {
        corSecundariaAtual = viewOverrideSecondary!;
    }
    bool podeVerFinanceiro = isAdmin && planoTemFinanceiro;
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @appName</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <style>
        :root {
            --ofc-primary: #0d6efd;
            --ofc-secondary: #6c757d;
            --ofc-primary-rgb: 13,110,253; /* fallback for alpha tints */
            --ofc-accent: #198754;
            --ofc-navbar-bg: #1f2937;
            --ofc-sidebar-bg: #111827;
            --ofc-bg: #0b1220;
            --ofc-surface: #0f172a;
            --ofc-text: #f8fafc;
            --ofc-text-muted: #cbd5e1;
            --ofc-border: #233047;
            /* Bootstrap mappings (globais) */
            --bs-primary: var(--ofc-primary);
            --bs-secondary: var(--ofc-secondary);
            --bs-link-color: var(--ofc-primary);
            --bs-link-hover-color: var(--ofc-primary);
        }
        [data-theme="light"] {
            --ofc-navbar-bg: #0d6efd;
            --ofc-sidebar-bg: #f8f9fa;
            --ofc-bg: #ffffff;
            --ofc-surface: #ffffff;
            --ofc-text: #1f2937;
            --ofc-text-muted: #475569;
            --ofc-border: #e5e7eb;
        }
        body { background-color: var(--ofc-bg); color: var(--ofc-text); }
        /* Global font size adjustment: all pages except Painel */
        body.page-common { font-size: 0.90rem; }
        body.page-common h1 { font-size: calc(2.5rem * .88); }
        body.page-common h2 { font-size: calc(2rem * .88); }
        body.page-common h3 { font-size: calc(1.75rem * .88); }
        body.page-common .display-1,
        body.page-common .display-2,
        body.page-common .display-3,
        body.page-common .display-4,
        body.page-common .display-5,
        body.page-common .display-6 { font-size: 0.88em; }
        body.page-common .btn { font-size: .85rem; }
        body.page-common .table, body.page-common table.dataTable { font-size: .90rem; }
        body.page-common table.dataTable tbody td, body.page-common .table tbody td { padding: .45rem .5rem; }
        body.page-common .form-control, body.page-common .form-select { font-size: .9rem; }
        /* DataTables UI */
        body.page-common .dt-container,
        body.page-common .dt-container label,
        body.page-common .dt-container .dt-input,
        body.page-common .dt-container .dt-search input,
        body.page-common .dt-container .dt-length select,
        body.page-common .dt-container .dt-paging .dt-paging-button { font-size: .9rem; }
        body.page-common .dt-buttons .btn { font-size: .8rem; padding: .25rem .5rem; }
        /* Center page titles (H1) by default */
        .content h1 { text-align: center; }
        .navbar { background-color: var(--ofc-navbar-bg) !important; }
        .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-text { color: #fff; }
        .layout { display: flex; min-height: calc(100vh - 56px); }
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg,
                rgba(var(--ofc-primary-rgb), .16) 0%,
                rgba(var(--ofc-primary-rgb), .08) 35%,
                var(--ofc-sidebar-bg) 100%);
            border-right: 1px solid var(--ofc-border);
            transition: margin-left .2s ease-in-out;
        }
        .sidebar.collapsed { margin-left: -260px; }
        .sidebar .nav-link { color: var(--ofc-text-muted); }
        .sidebar .nav-link.active, .sidebar .nav-link:hover { background: rgba(13,110,253,.1); color: var(--ofc-primary); }
        .sidebar .nav .collapse .nav-link { padding-left: 2rem; font-size: .9rem; }
        .sidebar .nav .collapse .nav-link::before {
            content: "•";
            margin-right: .35rem;
            color: var(--ofc-primary);
        }
        .content { flex: 1; background-color: var(--ofc-surface); }
        .content .container-fluid { padding: 1rem; }
        .brand-logo { width: 28px; height: 28px; object-fit: contain; }

        /* Bootstrap variable overrides for dark theme to ensure contrast */
        [data-theme="dark"] {
            --bs-body-bg: var(--ofc-bg);
            --bs-body-color: var(--ofc-text);
            --bs-border-color: var(--ofc-border);
            --bs-card-bg: var(--ofc-surface);
            --bs-card-color: var(--ofc-text);
            --bs-link-color: var(--ofc-primary);
            --bs-link-hover-color: var(--ofc-primary);
            --bs-table-color: var(--ofc-text);
            --bs-table-bg: transparent;
            --bs-secondary-color: var(--ofc-text-muted);
            --bs-primary: var(--ofc-primary);
            --bs-secondary: var(--ofc-secondary);
        }

        /* Links e elementos com realce */
        a, .nav-link { color: var(--ofc-primary); }
        a:hover, .nav-link:hover { filter: brightness(1.1); }

        /* Components contrast */
        [data-theme="dark"] .card, [data-theme="dark"] .modal-content { background-color: var(--ofc-surface); color: var(--ofc-text); border-color: var(--ofc-border); }
        [data-theme="dark"] .table { color: var(--ofc-text); }
        [data-theme="dark"] .table th, [data-theme="dark"] .table td { border-color: var(--ofc-border); }
        /* Center column headers by default */
        table.table thead th, table.dataTable thead th, .dataTables_scrollHead th { text-align: center !important; vertical-align: middle !important; }
        /* But keep filter-row cells left-aligned for inputs/selects */
        thead .dt-filters th { text-align: left !important; }
        /* Enforce table text contrast */
        [data-theme="dark"] .table, 
        [data-theme="dark"] .table td,
        [data-theme="dark"] .table th,
        [data-theme="dark"] table.dataTable tbody tr,
        [data-theme="dark"] table.dataTable tbody td,
        [data-theme="dark"] table.dataTable thead th {
            color: var(--ofc-text) !important;
        }
        /* Bootstrap table vars for dark theme */
        [data-theme="dark"] {
            --bs-table-color: var(--ofc-text);
            --bs-table-bg: transparent;
            --bs-table-border-color: var(--ofc-border);
            --bs-table-striped-bg: rgba(255,255,255,.05);
            --bs-table-striped-color: var(--ofc-text);
            --bs-table-hover-bg: rgba(255,255,255,.08);
            --bs-table-hover-color: var(--ofc-text);
            --bs-table-active-bg: rgba(255,255,255,.10);
            --bs-table-active-color: var(--ofc-text);
        }
        [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(255,255,255,.03); }
        [data-theme="dark"] .table-hover tbody tr:hover { background-color: rgba(255,255,255,.06); }
        [data-theme="dark"] .form-label, [data-theme="dark"] label { color: var(--ofc-text); }
        [data-theme="dark"] .form-control, [data-theme="dark"] .form-select, [data-theme="dark"] .form-control:focus, [data-theme="dark"] .form-select:focus {
            background-color: var(--ofc-surface);
            color: var(--ofc-text);
            border-color: var(--ofc-border);
        }
        [data-theme="dark"] .form-control::placeholder { color: var(--ofc-text-muted); }
        [data-theme="dark"] .input-group-text { background-color: var(--ofc-surface); color: var(--ofc-text); border-color: var(--ofc-border); }
        /* Botões primários respeitam a cor em qualquer tema */
        .btn-primary { background-color: var(--ofc-primary); border-color: var(--ofc-primary); }
        .btn-outline-primary { color: var(--ofc-primary); border-color: var(--ofc-primary); }
        .btn-outline-primary:hover { background-color: var(--ofc-primary); color: #fff; }
        [data-theme="dark"] .btn-secondary { background-color: var(--ofc-secondary); border-color: var(--ofc-secondary); }
        [data-theme="dark"] .page-link { background-color: var(--ofc-surface); color: var(--bs-link-color); border-color: var(--ofc-border); }
        [data-theme="dark"] .page-link:hover { background-color: rgba(255,255,255,.06); }
        /* DataTables dark theme tweaks */
        [data-theme="dark"] .dt-container .dt-input { background-color: var(--ofc-surface); color: var(--ofc-text); border: 1px solid var(--ofc-border); }
        [data-theme="dark"] .dt-container .dt-length label, [data-theme="dark"] .dt-container .dt-search label { color: var(--ofc-text); }
        [data-theme="dark"] .dt-container .dt-paging .dt-paging-button { background-color: var(--ofc-surface); color: var(--ofc-text); border-color: var(--ofc-border); }
        [data-theme="dark"] .dt-container .dt-paging .dt-paging-button.current { background-color: var(--ofc-primary); color: #fff; border-color: var(--ofc-primary); }
        /* Cabeçalhos das tabelas usam a cor do tema (ambos os temas) */
        table.dataTable>thead>tr>th, table.table thead th { background-color: rgba(var(--ofc-primary-rgb), .08) !important; }
        [data-theme="dark"] table.dataTable>thead>tr>th { color: var(--ofc-text) !important; border-color: var(--ofc-border) !important; background-color: rgba(var(--ofc-primary-rgb), .15) !important; }
        thead .dt-filters th { background-color: rgba(var(--ofc-primary-rgb), .05) !important; }
        [data-theme="dark"] thead .dt-filters th { background-color: rgba(var(--ofc-primary-rgb), .08) !important; }
        [data-theme="dark"] thead .dt-filters input { background-color: var(--ofc-surface); color: var(--ofc-text); border: 1px solid var(--ofc-border); }
        [data-theme="dark"] thead .dt-filters select { background-color: var(--ofc-surface); color: var(--ofc-text); border: 1px solid var(--ofc-border); }
        [data-theme="dark"] table.dataTable tbody tr { background-color: transparent !important; }
        [data-theme="dark"] table.dataTable tbody tr:hover { background-color: rgba(255,255,255,.06) !important; }
        [data-theme="dark"] .dt-container .dt-search input { background-color: var(--ofc-surface); color: var(--ofc-text); border: 1px solid var(--ofc-border); }
        /* DataTables 1.x wrappers */
        [data-theme="dark"] .dataTables_length select,
        [data-theme="dark"] .dataTables_filter input { background-color: var(--ofc-surface); color: var(--ofc-text); border: 1px solid var(--ofc-border); }
        .dt-buttons .btn { background-color: var(--ofc-primary); border-color: var(--ofc-primary); color: #fff; }
        .dt-buttons .btn:hover { filter: brightness(1.1); }

        /* Paginação e inputs ativos com a cor do tema */
        .page-item.active .page-link { background-color: var(--ofc-primary); border-color: var(--ofc-primary); }
        .form-check-input:checked { background-color: var(--ofc-primary); border-color: var(--ofc-primary); }
        .form-range::-webkit-slider-thumb { background-color: var(--ofc-primary); }
    </style>
    @* Override com cores do banco *@
    <style>
        :root,
        [data-theme="light"],
        [data-theme="dark"] {
            --ofc-primary: @corPrimariaAtual;
            --ofc-secondary: @corSecundariaAtual;
            --ofc-navbar-bg: @corPrimariaAtual;
            --bs-primary: @corPrimariaAtual;
            --bs-link-color: @corPrimariaAtual;
            --bs-link-hover-color: @corPrimariaAtual;
        }
    </style>

    <script>
        // Atualiza --ofc-primary-rgb com base em --ofc-primary para suportar transparências
        (function(){
            function hexToRgb(hex){
                if(!hex) return null;
                hex = hex.trim();
                if (hex.startsWith('#')) hex = hex.substring(1);
                if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
                var n = parseInt(hex,16);
                if (isNaN(n)) return null;
                return [(n>>16)&255, (n>>8)&255, n&255];
            }
            function refresh(){
                var p = getComputedStyle(document.documentElement).getPropertyValue('--ofc-primary');
                var rgb = hexToRgb(p);
                if(rgb){ document.documentElement.style.setProperty('--ofc-primary-rgb', rgb.join(',')); }
            }
            document.addEventListener('DOMContentLoaded', refresh);
        })();
    </script>
</head>
<body data-theme="light" class="@(isPainelPage ? "page-painel" : "page-common")">
    <nav class="navbar navbar-expand navbar-dark">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                @if (isAuthenticated)
                {
                    <button id="sidebarToggle" class="btn btn-outline-light btn-sm me-2" type="button" title="Alternar menu">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                }
                @if (isAuthenticated)
                {
                    <a class="navbar-brand d-flex align-items-center" asp-controller="Painel" asp-action="Index">
                        <img class="brand-logo me-2" src="@Url.Content(string.IsNullOrWhiteSpace(cfg?.LogoPath) ? "/logo.png" : cfg!.LogoPath)" asp-append-version="true" alt="Logo" onerror="this.style.display='none'">
                        <span>@brandLabel</span>
                    </a>
                }
                else
                {
                    <a class="navbar-brand d-flex align-items-center" asp-controller="Account" asp-action="Login">
                        <img class="brand-logo me-2" src="@Url.Content(string.IsNullOrWhiteSpace(cfg?.LogoPath) ? "/logo.png" : cfg!.LogoPath)" asp-append-version="true" alt="Logo" onerror="this.style.display='none'">
                        <span>@brandLabel</span>
                    </a>
                }
            </div>
            <div class="d-flex align-items-center">
                @if (isAuthenticated)
                {
                    <div class="text-end me-3">
                        <div class="small text-muted">Oficina atual</div>
                        <div class="fw-semibold">@nomeOficinaAtual</div>
                        @if (!string.IsNullOrWhiteSpace(grupoAtual))
                        {
                            <div class="small text-muted">@grupoAtual</div>
                        }
                        <a class="btn btn-link btn-sm p-0" asp-controller="Oficinas" asp-action="Selecionar">Trocar</a>
                    </div>
                }
                <span class="badge bg-info text-dark me-3">Plano: @PlanoLabel(planoAtual)</span>
                <button id="themeToggle" class="btn btn-outline-light btn-sm me-3" type="button">Tema</button>
                <span class="navbar-text me-2">@displayName</span>
                @if (isAuthenticated)
                {
                    <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline ms-2">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-light btn-sm">Sair</button>
                    </form>
                }
                else
                {
                    <a class="btn btn-outline-light btn-sm me-2" asp-controller="Account" asp-action="Login">Entrar</a>
                    <a class="btn btn-light btn-sm" asp-controller="Account" asp-action="Register">Registrar</a>
                }
            </div>
        </div>
    </nav>

    <div class="layout">
        @if (isAuthenticated)
        {
            <aside id="sidebar" class="sidebar">
                <nav class="nav flex-column p-2">
                    @if (isAdminOrSupervisor)
                    {
                        <a class="nav-link" asp-controller="Painel" asp-action="Index">Painel</a>
                        <a class="nav-link" asp-controller="Clientes" asp-action="Index">Clientes</a>
                        <a class="nav-link" asp-controller="Veiculos" asp-action="Index">Veículos</a>
                        <a class="nav-link" asp-controller="OrdensServico" asp-action="Index">Ordens de Serviço</a>
                        @if (planoTemEstoque)
                        {
                            <div class="nav-item">
                                <a class="nav-link d-flex justify-content-between align-items-center @(isEstoqueSection ? "active" : string.Empty)"
                                   data-bs-toggle="collapse"
                                   href="#menuEstoque"
                                   role="button"
                                   aria-expanded="@(isEstoqueSection.ToString().ToLower())"
                                   aria-controls="menuEstoque">
                                    <span>Estoque</span>
                                    <span class="small">@((isEstoqueSection ? "▲" : "▼"))</span>
                                </a>
                                <div class="collapse @(isEstoqueSection ? "show" : string.Empty)" id="menuEstoque">
                                    <a class="nav-link ms-4" asp-controller="Estoque" asp-action="Index">Visão geral</a>
                                    <a class="nav-link ms-4" asp-controller="MovimentacaoEstoque" asp-action="Index">Movimentações</a>
                                    <a class="nav-link ms-4" asp-controller="Peca" asp-action="Index">Peças</a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <span class="nav-link disabled text-muted" title="Disponível no Plano Pro">Estoque (Plano Pro)</span>
                        }
                        @if (isAdmin)
                        {
                            <a class="nav-link" asp-controller="AdminOficinas" asp-action="Index">Minhas Oficinas</a>
                            <a class="nav-link" asp-controller="Funcionarios" asp-action="Index">Funcionários</a>
                            <a class="nav-link" asp-controller="ContasFinanceiras" asp-action="Index">Contas financeiras</a>
                        }
                        if (podeVerFinanceiro)
                        {
                            <a class="nav-link" asp-controller="Financeiro" asp-action="Index">Financeiro</a>
                            <a class="nav-link ms-4" asp-controller="LancamentosFinanceiros" asp-action="Index">Lançamentos</a>
                        }
                        else if (isAdmin)
                        {
                            <span class="nav-link disabled text-muted" title="Disponível no Plano Plus">Financeiro (Plano Plus)</span>
                        }
                        if (isAdmin || isSuporte || isDiretor)
                        {
                            <a class="nav-link" asp-controller="Convites" asp-action="Index">Convites</a>
                        }
                        <a class="nav-link" asp-controller="Suporte" asp-action="Index">Suporte</a>
                    }
                    else if (isMecanico)
                    {
                        <a class="nav-link" asp-controller="OrdensServico" asp-action="Minhas">Minhas OS</a>
                    }
                    else if (isDiretor)
                    {
                        <a class="nav-link" asp-controller="Diretor" asp-action="Index">Meus Grupos</a>
                    }
                    else if (isSuporte)
                    {
                        <a class="nav-link" asp-controller="Grupos" asp-action="Index">Grupos de Oficinas</a>
                        <a class="nav-link" asp-controller="Suporte" asp-action="Index">Configurações do Ambiente</a>
                    }
                </nav>
            </aside>
        }
        <main class="content">
            <div class="container-fluid">
                @RenderBody()
            </div>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/fixedHeader.bootstrap5.min.js"></script>
    <script>
        (() => {
            const host = document.body;
            const themeKey = 'ofc-theme';
            const stored = localStorage.getItem(themeKey) || host.getAttribute('data-theme') || 'light';
            host.setAttribute('data-theme', stored);
            document.getElementById('themeToggle')?.addEventListener('click', () => {
                const current = host.getAttribute('data-theme') || 'light';
                const next = current === 'light' ? 'dark' : 'light';
                host.setAttribute('data-theme', next);
                localStorage.setItem(themeKey, next);
            });

            document.getElementById('sidebarToggle')?.addEventListener('click', () => {
                document.getElementById('sidebar')?.classList.toggle('collapsed');
            });

            // DataTables init moved to per-page scripts
        })();
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>



